<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Bouncing Balls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        canvas {
            display: block;
            cursor: crosshair;
            transition: background-color 0.5s ease;
        }
        /* Custom switch styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            flex-shrink: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6;
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }
        /* Custom select styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%202000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233b82f6%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 0.65rem auto;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <!-- Controls Sidebar -->
    <div class="w-full md:w-80 bg-slate-800 p-6 flex flex-col gap-6 shadow-xl z-10 overflow-y-auto" style="min-width: 320px;">
        <div>
            <h1 class="text-2xl font-bold text-blue-400 mb-2">Rhythm Balls V3</h1>
            <p class="text-sm text-slate-400">Balls gate the music on impact.</p>
        </div>

        <!-- Audio Section -->
        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
            <h2 class="font-semibold mb-3 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                Music Source
            </h2>
            <input type="file" id="audioInput" accept="audio/*" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 mb-2"/>
            <p id="audioStatus" class="text-xs text-yellow-400">Upload a song to start</p>
             <div class="mt-4">
                <label class="text-sm text-slate-300 block mb-1 flex justify-between">
                    <span>Master Volume</span>
                    <span id="volValue">50%</span>
                </label>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" class="w-full accent-blue-500">
            </div>
        </div>

        <!-- Terrain Section -->
        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
            <h2 class="font-semibold mb-3 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                Environment
            </h2>
            <select id="terrainSelect" class="w-full bg-slate-800 border border-slate-600 text-slate-200 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                <option value="earth" selected>üåé Earth (Normal)</option>
                <option value="moon">üåë Moon (Low Gravity)</option>
                <option value="rubber">ü•é Rubber Room (Bouncy)</option>
                <option value="slime">ü¶† Thick Slime (High Drag)</option>
                <option value="ice">‚ùÑÔ∏è Ice (Slippery)</option>
            </select>
        </div>

        <!-- Modes Section -->
        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex-grow">
            <h2 class="font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
                Impact Modes
            </h2>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">No Friction</span>
                        <span class="text-xs text-slate-400">Zero drag override</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="modeNoFriction">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">Super Bounce</span>
                        <span class="text-xs text-slate-400">Gain energy on hit</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="modeBounce">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">Speed Up</span>
                        <span class="text-xs text-slate-400">Faster every hit</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="modeSpeed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">Grow</span>
                        <span class="text-xs text-slate-400">Get bigger on hit</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="modeGrow">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-purple-300">Multiply</span>
                        <span class="text-xs text-slate-400">Split on strong hits</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="modeMultiply">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col gap-2">
            <button id="startBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition flex items-center justify-center gap-2">
                Start / Add Ball
            </button>
            <button id="clearBtn" class="w-full py-2 bg-slate-700 hover:bg-red-500/20 text-slate-300 hover:text-red-300 font-semibold rounded-xl transition">
                Clear All Balls
            </button>
        </div>
        <div class="text-center text-xs text-slate-500" id="ballCount">
            Balls: 0 (Max 200)
        </div>
    </div>

    <!-- Canvas Container -->
    <div class="flex-grow relative bg-slate-900" id="canvasContainer">
        <canvas id="gameCanvas" class="w-full h-full"></canvas>
        <div id="tutorial" class="pointer-events-none absolute inset-0 flex items-center justify-center bg-black/50 transition-opacity duration-500 opacity-100">
            <div class="text-center p-6 bg-slate-800 rounded-2xl border border-slate-600 shadow-2xl max-w-md mx-4">
                <h3 class="text-xl font-bold text-white mb-2">Rhythm Balls V3</h3>
                <p class="text-slate-300 mb-4">1. Upload a song.<br>2. Select your environment.<br>3. Click Start to drop balls!</p>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let balls = [];
        const MAX_BALLS = 200; 

        // --- Terrain Definitions ---
        const TERRAINS = {
            earth:  { gravity: 0.4,  friction: 0.98,  bounce: 0.6,  bg: '#0f172a' },
            moon:   { gravity: 0.08, friction: 0.995, bounce: 0.8,  bg: '#1e293b' },
            rubber: { gravity: 0.4,  friction: 0.98,  bounce: 0.95, bg: '#312e81' },
            slime:  { gravity: 0.5,  friction: 0.92,  bounce: 0.2,  bg: '#064e3b' },
            ice:    { gravity: 0.4,  friction: 0.999, bounce: 0.6,  bg: '#0c4a6e' }
        };
        let currentTerrain = TERRAINS.earth;

        // Modes that override base physics on impact
        const SUPER_BOUNCE_VAL = 1.15;

        let modes = {
            noFriction: false,
            superBounce: false,
            speedUp: false,
            grow: false,
            multiply: false
        };

        // --- Audio Engine (Gated Loop) ---
        let audioCtx = null;
        let audioBuffer = null;
        let sourceNode = null;
        let gateNode = null;
        let masterGain = null;
        let isPlaying = false;

        // --- Setup ---
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Audio Handling ---
        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                gateNode = audioCtx.createGain();
                gateNode.gain.value = 0.0;
                gateNode.connect(masterGain);
                updateVolume();
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        function startBackgroundLoop() {
            if (!audioCtx || !audioBuffer || isPlaying) return;
            if (sourceNode) { try { sourceNode.stop(); } catch(e) {} }
            sourceNode = audioCtx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.loop = true;
            sourceNode.connect(gateNode);
            sourceNode.start(0);
            isPlaying = true;
        }

        document.getElementById('audioInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('audioStatus');
            status.textContent = "Loading... wait.";
            status.className = "text-xs text-blue-400 loading-pulse";

            if (isPlaying && sourceNode) {
                sourceNode.stop();
                isPlaying = false;
            }

            try {
                await initAudio();
                const arrayBuffer = await file.arrayBuffer();
                audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                status.textContent = `Ready: ${file.name.substring(0, 25)}`;
                status.className = "text-xs text-green-400";
            } catch (err) {
                status.textContent = "Error loading audio.";
                status.className = "text-xs text-red-400";
                console.error(err);
            }
        });

        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            updateVolume();
            document.getElementById('volValue').textContent = Math.round(e.target.value * 100) + '%';
        });

        function updateVolume() {
            if (masterGain) masterGain.gain.value = document.getElementById('volumeSlider').value;
        }

        function openAudioGate() {
            if (!audioCtx || !gateNode) return;
            if (!isPlaying && audioBuffer) startBackgroundLoop();
            const now = audioCtx.currentTime;
            gateNode.gain.cancelScheduledValues(now);
            gateNode.gain.setValueAtTime(gateNode.gain.value, now);
            gateNode.gain.linearRampToValueAtTime(1.0, now + 0.005);
            gateNode.gain.setTargetAtTime(0, now + 0.05, 0.25); 
        }

        // --- Game Logic ---

        class Ball {
            constructor(x, y, vx, vy, radius, color) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.radius = radius;
                this.color = color || `hsl(${Math.random() * 360}, 85%, 60%)`;
                this.lastMultiplyTime = 0;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.closePath();
                ctx.beginPath();
                ctx.arc(this.x - this.radius*0.3, this.y - this.radius*0.3, this.radius*0.25, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.fill();
                ctx.closePath();
            }

            update() {
                // Apply Terrain Physics
                this.vy += currentTerrain.gravity;
                
                // Apply friction (No Friction mode overrides terrain friction)
                if (!modes.noFriction) {
                    this.vx *= currentTerrain.friction;
                }

                this.x += this.vx;
                this.y += this.vy;

                let bounced = false;
                let impactVelocity = 0;

                // Floor
                if (this.y + this.radius > canvas.height) {
                    this.y = canvas.height - this.radius;
                    impactVelocity = Math.abs(this.vy);
                    // Determine if it should bounce or just roll based on terrain gravity
                    let bounceThreshold = currentTerrain.gravity * 2.5; 
                    if (modes.noFriction || impactVelocity > bounceThreshold) {
                        this.handleImpact('vertical');
                        bounced = true;
                    } else {
                        this.vy = 0; // Stabilize
                    }
                }
                // Ceiling
                else if (this.y - this.radius < 0) {
                    this.y = this.radius;
                    this.handleImpact('vertical');
                    bounced = true;
                }

                // Walls
                if (this.x + this.radius > canvas.width) {
                    this.x = canvas.width - this.radius;
                    this.handleImpact('horizontal');
                    bounced = true;
                } else if (this.x - this.radius < 0) {
                    this.x = this.radius;
                    this.handleImpact('horizontal');
                    bounced = true;
                }

                return bounced;
            }

            handleImpact(axis) {
                openAudioGate();

                // Determine base bounce from terrain or overrides
                let currentBounce = currentTerrain.bounce;
                
                if (modes.superBounce) {
                    currentBounce = SUPER_BOUNCE_VAL;
                } else if (modes.noFriction) {
                    currentBounce = 1.0; 
                }
                
                if (axis === 'vertical') {
                    this.vy = -this.vy * currentBounce;
                } else {
                    this.vx = -this.vx * currentBounce;
                }

                // --- Strict Mode Application ---
                if (modes.speedUp === true) {
                    this.vx *= 1.10;
                    this.vy *= 1.10;
                    this.vx = Math.max(Math.min(this.vx, 50), -50);
                    this.vy = Math.max(Math.min(this.vy, 50), -50);
                }

                if (modes.grow === true) {
                    if (this.radius < 100) this.radius *= 1.05;
                }

                if (modes.multiply === true) {
                    const now = Date.now();
                    if ((Math.abs(this.vx) > 6 || Math.abs(this.vy) > 6) && now - this.lastMultiplyTime > 200) {
                        this.lastMultiplyTime = now;
                        return true;
                    }
                }

                return false;
            }
        }

        // --- Main Loop ---
        function loop() {
            // Convert hex bg to rgba for trail effect
            let hex = currentTerrain.bg;
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);
            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.35)`;
            
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let ballsToSpawn = 0;
            for (let i = 0; i < balls.length; i++) {
                if (balls[i].update() === true) ballsToSpawn++;
                balls[i].draw();
            }

            if (ballsToSpawn > 0 && modes.multiply === true) {
                let spawnLimit = Math.min(ballsToSpawn, 5); 
                for(let i = 0; i < spawnLimit; i++) {
                    if (balls.length >= MAX_BALLS) break;
                    const parent = balls[Math.floor(Math.random() * balls.length)];
                    balls.push(new Ball(
                        parent.x, parent.y,
                        (Math.random() - 0.5) * 15, 
                        -Math.abs(parent.vy) * 0.8, 
                        Math.max(8, parent.radius * 0.6),
                        parent.color
                    ));
                }
                document.getElementById('ballCount').textContent = `Balls: ${balls.length} (Max ${MAX_BALLS})`;
            }
            requestAnimationFrame(loop);
        }

        // --- Controls Handlers ---
        document.getElementById('terrainSelect').addEventListener('change', (e) => {
            currentTerrain = TERRAINS[e.target.value];
            // Update canvas background immediately for better feel
            document.getElementById('canvasContainer').style.backgroundColor = currentTerrain.bg;
        });

        ['modeNoFriction', 'modeBounce', 'modeSpeed', 'modeGrow', 'modeMultiply'].forEach(id => {
             const el = document.getElementById(id);
             // Initial sync
             let prop = id.replace('mode', '');
             prop = prop.charAt(0).toLowerCase() + prop.slice(1);
             if (prop === 'bounce') prop = 'superBounce'; // fixing mismatch in naming conventions I made earlier
             modes[prop] = el.checked;

             el.addEventListener('change', (e) => {
                 modes[prop] = e.target.checked;
             });
        });

        function addBall(x, y) {
            if (balls.length >= MAX_BALLS) return;
            x = x || Math.random() * (canvas.width - 50) + 25;
            y = y || 50;
            balls.push(new Ball(x, y, (Math.random() - 0.5) * 15, Math.random() * 5, 20 + Math.random() * 15));
            document.getElementById('ballCount').textContent = `Balls: ${balls.length} (Max ${MAX_BALLS})`;
        }

        // --- Interaction Handlers ---
        const handleInteract = async (e) => {
            e.preventDefault();
            await initAudio();
            if (audioBuffer && !isPlaying) startBackgroundLoop();
            document.getElementById('tutorial').style.opacity = '0';

            let x, y;
            if (e.type === 'mousedown' || e.type === 'click') {
                const rect = canvas.getBoundingClientRect();
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            } else if (e.type === 'touchstart') {
                const rect = canvas.getBoundingClientRect();
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            }
            
            if (e.target.id === 'startBtn') {
                 addBall(canvas.width/2, 100);
            } else {
                 addBall(x, y);
            }
        };

        document.getElementById('startBtn').addEventListener('click', handleInteract);
        canvas.addEventListener('mousedown', handleInteract);
        canvas.addEventListener('touchstart', handleInteract, {passive: false});

        document.getElementById('clearBtn').addEventListener('click', () => {
            balls = [];
            document.getElementById('ballCount').textContent = `Balls: 0 (Max ${MAX_BALLS})`;
        });

        loop();

    </script>
</body>
</html>
