<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Bouncing Balls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        canvas {
            display: block;
            cursor: crosshair;
            transition: filter 0.3s ease;
        }
        /* Custom switch styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            flex-shrink: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6;
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }
        /* Custom select styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%202000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233b82f6%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 0.65rem auto;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <!-- Controls Sidebar -->
    <div class="w-full md:w-80 bg-slate-800 p-6 flex flex-col gap-6 shadow-xl z-10 overflow-y-auto" style="min-width: 320px;">
        <div>
            <h1 class="text-2xl font-bold text-blue-400 mb-2">Rhythm Balls V5</h1>
            <p class="text-sm text-slate-400">Balls gate the music on impact.</p>
        </div>

        <!-- Audio Section -->
        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 shrink-0">
            <h2 class="font-semibold mb-3 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                Music Source
            </h2>
            <input type="file" id="audioInput" accept="audio/*" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 mb-2"/>
            <p id="audioStatus" class="text-xs text-yellow-400">Upload a song to start</p>
             <div class="mt-4">
                <label class="text-sm text-slate-300 block mb-1 flex justify-between">
                    <span>Master Volume</span>
                    <span id="volValue">50%</span>
                </label>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" class="w-full accent-blue-500">
            </div>
        </div>

        <!-- Customization Section -->
        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex flex-col gap-4 shrink-0">
            <div>
                <h2 class="font-semibold mb-2 flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                    Visual Theme
                </h2>
                <select id="themeSelect" class="w-full bg-slate-800 border border-slate-600 text-slate-200 text-sm rounded-lg p-2.5">
                    <option value="classic" selected>‚ú® Classic</option>
                    <option value="neon">üåÉ Neon Nights</option>
                    <option value="wood">ü™µ Wooden Toy</option>
                    <option value="terminal">üìü Terminal</option>
                    <option value="bubblegum">üç¨ Bubblegum</option>
                </select>
            </div>
             <div class="grid grid-cols-2 gap-3">
                <div>
                    <h2 class="font-semibold mb-2 flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                        Physics
                    </h2>
                    <select id="terrainSelect" class="w-full bg-slate-800 border border-slate-600 text-slate-200 text-sm rounded-lg p-2.5">
                        <option value="earth" selected>Earth</option>
                        <option value="moon">Moon</option>
                        <option value="rubber">Rubber</option>
                        <option value="slime">Slime</option>
                        <option value="ice">Ice</option>
                    </select>
                </div>
                <div>
                    <h2 class="font-semibold mb-2 flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        Shape
                    </h2>
                    <select id="containerSelect" class="w-full bg-slate-800 border border-slate-600 text-slate-200 text-sm rounded-lg p-2.5">
                        <option value="window" selected>Window</option>
                        <option value="square">Square</option>
                        <option value="circle">Circle</option>
                        <option value="triangle">Triangle</option>
                        <option value="rotating-square">Spin Sq.</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Modes Section -->
        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex-grow overflow-y-auto min-h-[200px]">
            <h2 class="font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
                Impact Modes
            </h2>
            
            <div class="space-y-5">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium">No Friction</span>
                        <span class="text-xs text-slate-400">Zero drag override</span>
                    </div>
                    <label class="switch scale-110 origin-right">
                        <input type="checkbox" id="modeNoFriction">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium">Super Bounce</span>
                        <span class="text-xs text-slate-400">Gain energy on hit</span>
                    </div>
                    <label class="switch scale-110 origin-right">
                        <input type="checkbox" id="modeBounce">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium">Speed Up</span>
                        <span class="text-xs text-slate-400">Faster every hit</span>
                    </div>
                    <label class="switch scale-110 origin-right">
                        <input type="checkbox" id="modeSpeed">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium">Grow</span>
                        <span class="text-xs text-slate-400">Get bigger on hit</span>
                    </div>
                    <label class="switch scale-110 origin-right">
                        <input type="checkbox" id="modeGrow">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-bold text-purple-300">Multiply</span>
                        <span class="text-xs text-slate-400">Split on strong hits</span>
                    </div>
                    <label class="switch scale-110 origin-right">
                        <input type="checkbox" id="modeMultiply">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col gap-2 shrink-0">
            <button id="startBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition flex items-center justify-center gap-2">
                Start / Add Ball
            </button>
            <button id="clearBtn" class="w-full py-2 bg-slate-700 hover:bg-red-500/20 text-slate-300 hover:text-red-300 font-semibold rounded-xl transition">
                Clear All Balls
            </button>
        </div>
        <div class="text-center text-xs text-slate-500 shrink-0" id="ballCount">
            Balls: 0 (Max 200)
        </div>
    </div>

    <!-- Canvas Container -->
    <div class="flex-grow relative bg-slate-900" id="canvasContainer">
        <canvas id="gameCanvas" class="w-full h-full"></canvas>
        <div id="tutorial" class="pointer-events-none absolute inset-0 flex items-center justify-center bg-black/50 transition-opacity duration-500 opacity-100 z-20">
            <div class="text-center p-6 bg-slate-800 rounded-2xl border border-slate-600 shadow-2xl max-w-md mx-4">
                <h3 class="text-xl font-bold text-white mb-2">Rhythm Balls V5</h3>
                <p class="text-slate-300 mb-4">1. Upload a song.<br>2. Customize Theme & Physics.<br>3. Click Start to drop balls!</p>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let balls = [];
        const MAX_BALLS = 200; 

        // --- THEME SYSTEM Definitions ---
        const THEMES = {
            classic: {
                bg: (terrain) => terrain.bg, // Dynamic based on terrain
                fadeColor: (terrain) => {
                     // Convert hex bg to rgba for trail effect
                    let hex = terrain.bg;
                    let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                    return `rgba(${r}, ${g}, ${b}, 0.35)`;
                },
                containerStyle: (ctx) => {
                    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 3; ctx.shadowBlur = 0; ctx.setLineDash([]);
                },
                ballColor: () => `hsl(${Math.random() * 360}, 85%, 60%)`,
                drawBall: (ctx, ball) => {
                    ctx.shadowBlur = 0;
                    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
                    ctx.fillStyle = ball.color; ctx.fill(); ctx.closePath();
                    // Shine
                    ctx.beginPath(); ctx.arc(ball.x - ball.radius*0.3, ball.y - ball.radius*0.3, ball.radius*0.25, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.fill(); ctx.closePath();
                }
            },
            neon: {
                bg: () => '#09090b',
                fadeColor: () => 'rgba(9, 9, 11, 0.25)', // Darker fade for stronger trails
                containerStyle: (ctx) => {
                    ctx.strokeStyle = '#0ff'; ctx.lineWidth = 4; ctx.shadowColor = '#0ff'; ctx.shadowBlur = 20; ctx.setLineDash([]);
                },
                ballColor: () => `hsl(${Math.random() * 360}, 100%, 50%)`,
                drawBall: (ctx, ball) => {
                    ctx.shadowColor = ball.color; ctx.shadowBlur = 25;
                    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
                    ctx.fillStyle = '#fff'; ctx.fill(); // White center for intense neon look
                    ctx.lineWidth = 3; ctx.strokeStyle = ball.color; ctx.stroke(); ctx.closePath();
                }
            },
            wood: {
                bg: () => '#785c38', // Matte brown
                fadeColor: () => 'rgba(120, 92, 56, 0.5)',
                containerStyle: (ctx) => {
                    ctx.strokeStyle = '#3f2e18'; ctx.lineWidth = 8; ctx.shadowBlur = 0; ctx.setLineDash([]);
                },
                ballColor: () => {
                    // Earthy wood tones
                    const hues = [30, 40, 25, 45];
                    return `hsl(${hues[Math.floor(Math.random()*hues.length)]}, ${40 + Math.random()*20}%, ${40 + Math.random()*30}%)`;
                },
                drawBall: (ctx, ball) => {
                    ctx.shadowBlur = 0;
                    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
                    ctx.fillStyle = ball.color; ctx.fill(); 
                    ctx.strokeStyle = '#3f2e18'; ctx.lineWidth = 2; ctx.stroke(); ctx.closePath();
                    // Simple wood grain effect
                    ctx.beginPath(); ctx.moveTo(ball.x - ball.radius*0.5, ball.y - ball.radius*0.2);
                    ctx.quadraticCurveTo(ball.x, ball.y, ball.x + ball.radius*0.5, ball.y - ball.radius*0.3);
                    ctx.strokeStyle = 'rgba(63, 46, 24, 0.3)'; ctx.lineWidth = 2; ctx.stroke();
                }
            },
            terminal: {
                bg: () => '#000000',
                fadeColor: () => 'rgba(0, 0, 0, 0.4)',
                containerStyle: (ctx) => {
                    ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 2; ctx.shadowBlur = 0; 
                     // Dashed lines for old school feel
                },
                ballColor: () => '#22c55e', // All green
                drawBall: (ctx, ball) => {
                    ctx.shadowBlur = 0;
                    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
                    ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 2; ctx.stroke(); 
                    ctx.fillStyle = '#000'; ctx.fill(); ctx.closePath();
                    // ASCII character in middle
                    ctx.font = `${Math.max(10, ball.radius)}px monospace`;
                    ctx.fillStyle = '#22c55e'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(String.fromCharCode(65 + Math.floor(Math.random()*26)), ball.x, ball.y);
                }
            },
            bubblegum: {
                bg: () => '#fce7f3', // Pink 100
                fadeColor: () => 'rgba(252, 231, 243, 0.4)',
                containerStyle: (ctx) => {
                    ctx.strokeStyle = '#f472b6'; ctx.lineWidth = 6; ctx.shadowColor = '#fbcfe8'; ctx.shadowBlur = 10; ctx.lineCap = 'round'; ctx.setLineDash([]);
                },
                ballColor: () => `hsl(${300 + Math.random() * 60}, 100%, 85%)`, // Pastels
                drawBall: (ctx, ball) => {
                    ctx.shadowBlur = 0;
                    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
                    ctx.fillStyle = ball.color; ctx.fill();
                    ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.stroke(); ctx.closePath();
                    // Cute highlight
                    ctx.beginPath(); ctx.ellipse(ball.x - ball.radius*0.3, ball.y - ball.radius*0.3, ball.radius*0.2, ball.radius*0.1, Math.PI/4, 0, Math.PI*2);
                     ctx.fillStyle = 'white'; ctx.fill();
                }
            }
        };
        let currentTheme = THEMES.classic;


        // --- Physics Constants ---
        const TERRAINS = {
            earth:  { gravity: 0.4,  friction: 0.98,  bounce: 0.6,  bg: '#0f172a' },
            moon:   { gravity: 0.08, friction: 0.995, bounce: 0.8,  bg: '#1e293b' },
            rubber: { gravity: 0.4,  friction: 0.98,  bounce: 0.95, bg: '#312e81' },
            slime:  { gravity: 0.5,  friction: 0.92,  bounce: 0.2,  bg: '#064e3b' },
            ice:    { gravity: 0.4,  friction: 0.999, bounce: 0.6,  bg: '#0c4a6e' }
        };
        let currentTerrain = TERRAINS.earth;
        let currentContainerType = 'window';
        let containerAngle = 0;

        const SUPER_BOUNCE_VAL = 1.15;
        let modes = {
            noFriction: false, superBounce: false, speedUp: false, grow: false, multiply: false
        };

        // --- Audio Engine (Gated Loop) ---
        let audioCtx, audioBuffer, sourceNode, gateNode, masterGain, isPlaying = false;

        // --- Vector Helpers ---
        function rotate(x, y, angle) {
            const cos = Math.cos(angle), sin = Math.sin(angle);
            return { x: x * cos - y * sin, y: x * sin + y * cos };
        }
        function dot(x1, y1, x2, y2) { return x1 * x2 + y1 * y2; }
        function normalize(x, y) {
            const len = Math.sqrt(x*x + y*y);
            return len === 0 ? {x:0, y:0} : {x: x/len, y: y/len};
        }

        // --- Container Logic ---
        const containers = {
            window: {
                draw: () => {}, // Nothing to draw
                check: (ball) => {
                    let bounced = false;
                    if (ball.y + ball.radius > canvas.height) {
                        ball.y = canvas.height - ball.radius;
                         if (modes.noFriction || Math.abs(ball.vy) > currentTerrain.gravity * 2.5) {
                            ball.handleImpact(0, -1); bounced = true;
                        } else { ball.vy = 0; }
                    } else if (ball.y - ball.radius < 0) {
                        ball.y = ball.radius; ball.handleImpact(0, 1); bounced = true;
                    }
                    if (ball.x + ball.radius > canvas.width) {
                        ball.x = canvas.width - ball.radius; ball.handleImpact(-1, 0); bounced = true;
                    } else if (ball.x - ball.radius < 0) {
                        ball.x = ball.radius; ball.handleImpact(1, 0); bounced = true;
                    }
                    return bounced;
                }
            },
            circle: {
                draw: (cx, cy, size) => {
                    currentTheme.containerStyle(ctx);
                    ctx.beginPath(); ctx.arc(cx, cy, size/2, 0, Math.PI*2); ctx.stroke();
                },
                check: (ball, cx, cy, size) => {
                    const r = size/2, dx = ball.x - cx, dy = ball.y - cy, dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist + ball.radius > r) {
                        const normal = normalize(-dx, -dy), overlap = (dist + ball.radius) - r;
                        ball.x += normal.x * overlap; ball.y += normal.y * overlap;
                        ball.handleImpact(normal.x, normal.y); return true;
                    } return false;
                }
            },
            square: {
                draw: (cx, cy, size, angle = 0) => {
                    ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle);
                    currentTheme.containerStyle(ctx);
                    ctx.strokeRect(-size/2, -size/2, size, size);
                    ctx.restore();
                },
                check: (ball, cx, cy, size, angle = 0) => {
                    let local = rotate(ball.x - cx, ball.y - cy, -angle), bounced = false, half = size/2;
                    if (local.x + ball.radius > half) { local.x = half - ball.radius; let n = rotate(-1, 0, angle); ball.handleImpact(n.x, n.y); bounced = true; }
                    else if (local.x - ball.radius < -half) { local.x = -half + ball.radius; let n = rotate(1, 0, angle); ball.handleImpact(n.x, n.y); bounced = true; }
                    if (local.y + ball.radius > half) { local.y = half - ball.radius; let n = rotate(0, -1, angle); ball.handleImpact(n.x, n.y); bounced = true; }
                    else if (local.y - ball.radius < -half) { local.y = -half + ball.radius; let n = rotate(0, 1, angle); ball.handleImpact(n.x, n.y); bounced = true; }
                    if (bounced) { let world = rotate(local.x, local.y, angle); ball.x = cx + world.x; ball.y = cy + world.y; }
                    return bounced;
                }
            },
            triangle: {
                 draw: (cx, cy, size) => {
                    const h = size * (Math.sqrt(3)/2);
                    currentTheme.containerStyle(ctx);
                    ctx.beginPath(); ctx.moveTo(cx, cy - 2*h/3); ctx.lineTo(cx - size/2, cy + h/3); ctx.lineTo(cx + size/2, cy + h/3); ctx.closePath(); ctx.stroke();
                },
                check: (ball, cx, cy, size) => {
                    const h = size * (Math.sqrt(3)/2);
                    const v1 = {x: cx, y: cy - 2*h/3}, v2 = {x: cx - size/2, y: cy + h/3}, v3 = {x: cx + size/2, y: cy + h/3};
                    let bounced = false;
                    const checkPlane = (p1, p2) => {
                        const dx = p2.x - p1.x, dy = p2.y - p1.y;
                        let nx = -dy, ny = dx; const len = Math.sqrt(nx*nx + ny*ny); nx /= len; ny /= len;
                        const dist = (ball.x - p1.x) * nx + (ball.y - p1.y) * ny;
                        if (dist < ball.radius) { ball.x += nx * (ball.radius - dist); ball.y += ny * (ball.radius - dist); ball.handleImpact(nx, ny); return true; }
                        return false;
                    }
                    if (checkPlane(v1, v2)) bounced = true; if (!bounced && checkPlane(v2, v3)) bounced = true; if (!bounced && checkPlane(v3, v1)) bounced = true;
                    return bounced;
                }
            }
        };
        containers['rotating-square'] = containers.square;

        // --- Game Objects ---
        class Ball {
            constructor(x, y, vx, vy, radius, color) {
                this.x = x; this.y = y; this.vx = vx; this.vy = vy;
                this.radius = radius;
                // If color not provided, generate based on current theme
                this.color = color || currentTheme.ballColor(); 
                this.lastMultiplyTime = 0;
            }
            draw() {
                currentTheme.drawBall(ctx, this);
            }
            update() {
                this.vy += currentTerrain.gravity;
                if (!modes.noFriction) this.vx *= currentTerrain.friction;
                this.x += this.vx; this.y += this.vy;

                const cx = canvas.width/2, cy = canvas.height/2, size = Math.min(canvas.width, canvas.height) * 0.7;
                if (currentContainerType === 'window') return containers.window.check(this);
                else if (currentContainerType === 'rotating-square') return containers.square.check(this, cx, cy, size, containerAngle);
                else return containers[currentContainerType].check(this, cx, cy, size);
            }

            handleImpact(nx, ny) {
                openAudioGate();
                let bounce = currentTerrain.bounce;
                if (modes.superBounce) bounce = SUPER_BOUNCE_VAL;
                if (modes.noFriction) bounce = 1.0;

                const d = dot(this.vx, this.vy, nx, ny);
                this.vx = (this.vx - 2 * d * nx) * bounce;
                this.vy = (this.vy - 2 * d * ny) * bounce;

                if (modes.speedUp) { this.vx *= 1.1; this.vy *= 1.1; this.vx = Math.max(Math.min(this.vx, 50), -50); this.vy = Math.max(Math.min(this.vy, 50), -50); }
                if (modes.grow && this.radius < 60) this.radius *= 1.05;
                if (modes.multiply) {
                    const now = Date.now();
                    if ((Math.abs(this.vx) + Math.abs(this.vy) > 8) && now - this.lastMultiplyTime > 200) {
                        this.lastMultiplyTime = now; return true;
                    }
                }
                return false;
            }
        }

        // --- Main Loop ---
        function loop() {
            // Theme-based background trail
            ctx.fillStyle = currentTheme.fadeColor(currentTerrain);
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (currentContainerType === 'rotating-square') containerAngle += 0.005;

            const cx = canvas.width/2, cy = canvas.height/2, size = Math.min(canvas.width, canvas.height) * 0.7;
            if (currentContainerType === 'rotating-square') containers.square.draw(cx, cy, size, containerAngle);
            else if (currentContainerType !== 'window') containers[currentContainerType].draw(cx, cy, size);

            let ballsToSpawn = 0;
            for (let i = 0; i < balls.length; i++) {
                if (balls[i].update()) ballsToSpawn++;
                balls[i].draw();
            }

            if (ballsToSpawn > 0 && modes.multiply) {
                let limit = Math.min(ballsToSpawn, 3); 
                for(let i=0; i<limit; i++) {
                    if (balls.length >= MAX_BALLS) break;
                    const p = balls[Math.floor(Math.random() * balls.length)];
                    // Inherit color for themes where it matters
                    balls.push(new Ball(p.x, p.y, (Math.random()-0.5)*15, (Math.random()-0.5)*15, Math.max(8, p.radius*0.6), p.color));
                }
                document.getElementById('ballCount').textContent = `Balls: ${balls.length} (Max ${MAX_BALLS})`;
            }
            requestAnimationFrame(loop);
        }

        // --- Initialization & Events ---
        function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination);
                gateNode = audioCtx.createGain(); gateNode.gain.value = 0; gateNode.connect(masterGain);
                masterGain.gain.value = document.getElementById('volumeSlider').value;
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }
        function openAudioGate() {
            if (!audioCtx || !gateNode) return;
            if (!isPlaying && audioBuffer) {
                if (sourceNode) try{sourceNode.stop()}catch(e){}
                sourceNode = audioCtx.createBufferSource(); sourceNode.buffer = audioBuffer;
                sourceNode.loop = true; sourceNode.connect(gateNode); sourceNode.start(0); isPlaying = true;
            }
            const now = audioCtx.currentTime;
            gateNode.gain.cancelScheduledValues(now);
            gateNode.gain.setValueAtTime(gateNode.gain.value, now);
            gateNode.gain.linearRampToValueAtTime(1.0, now + 0.005);
            gateNode.gain.setTargetAtTime(0, now + 0.05, 0.25);
        }

        // UI Listeners
        document.getElementById('audioInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            document.getElementById('audioStatus').textContent = "Loading...";
            if(isPlaying && sourceNode) { sourceNode.stop(); isPlaying = false; }
            try {
                await initAudio();
                audioBuffer = await audioCtx.decodeAudioData(await file.arrayBuffer());
                document.getElementById('audioStatus').textContent = "Ready: " + file.name.substring(0,20);
                document.getElementById('audioStatus').className = "text-xs text-green-400";
            } catch(e) { console.error(e); document.getElementById('audioStatus').textContent = "Error loading."; }
        });
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
           if(masterGain) masterGain.gain.value = e.target.value;
           document.getElementById('volValue').textContent = Math.round(e.target.value*100)+'%';
        });
        
        // --- Theme & Terrain Selectors ---
        function updateEnvironment() {
             // Use theme bg if it's a function that doesn't depend on terrain, or just overrides it
             const newBg = currentTheme.bg(currentTerrain);
             document.getElementById('canvasContainer').style.backgroundColor = newBg;
        }

        document.getElementById('themeSelect').addEventListener('change', (e) => {
            currentTheme = THEMES[e.target.value];
            updateEnvironment();
            // Optional: re-colorize existing balls to match new theme
             balls.forEach(b => b.color = currentTheme.ballColor());
        });
        document.getElementById('terrainSelect').addEventListener('change', (e) => {
            currentTerrain = TERRAINS[e.target.value];
            updateEnvironment();
        });

        document.getElementById('containerSelect').addEventListener('change', (e) => {
            currentContainerType = e.target.value;
            balls = []; document.getElementById('ballCount').textContent = `Balls: 0 (Max ${MAX_BALLS})`;
        });
        ['modeNoFriction','modeBounce','modeSpeed','modeGrow','modeMultiply'].forEach(id => {
            const el = document.getElementById(id);
            let prop = id.replace('mode',''); prop = prop.charAt(0).toLowerCase() + prop.slice(1);
            if(prop==='bounce') prop='superBounce';
            modes[prop] = el.checked;
            el.addEventListener('change', e => modes[prop] = e.target.checked);
        });

        const interact = async (e) => {
            e.preventDefault(); await initAudio();
            document.getElementById('tutorial').style.opacity = '0';
            let x, y;
            if (currentContainerType === 'window') {
                const rect = canvas.getBoundingClientRect();
                x = (e.clientX || e.touches[0].clientX) - rect.left;
                y = (e.clientY || e.touches[0].clientY) - rect.top;
                if (e.target.id === 'startBtn') { x = canvas.width/2; y = 100; }
            } else { x = canvas.width/2; y = canvas.height/2; }

            if (balls.length < MAX_BALLS) {
                balls.push(new Ball(x, y, (Math.random()-0.5)*10, Math.random()*5, 15+Math.random()*10));
                document.getElementById('ballCount').textContent = `Balls: ${balls.length} (Max ${MAX_BALLS})`;
            }
        };
        document.getElementById('startBtn').addEventListener('click', interact);
        canvas.addEventListener('mousedown', interact);
        canvas.addEventListener('touchstart', interact, {passive:false});
        document.getElementById('clearBtn').addEventListener('click', () => {
            balls = []; document.getElementById('ballCount').textContent = `Balls: 0 (Max ${MAX_BALLS})`;
        });

        loop();
    </script>
</body>
</html>
